name: post-to-teams
on:
  workflow_call:
    inputs:
      cardType:
        description: "push | pr"
        required: true
        type: string
      pr_number:
        required: false
        type: string
      pr_title:
        required: false
        type: string
      pr_head:
        required: false
        type: string
      pr_base:
        required: false
        type: string
      compare_url:
        required: false
        type: string
    secrets:
      TEAMS_WEBHOOK_URL:
        required: true

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get last 3 commit messages
        id: commits
        run: |
          git fetch --depth=5
          COMMITS=$(git log -3 --pretty=format:"%h|||%s")
          i=1
          for COMMIT in $COMMITS; do
            MSG=$(echo "$COMMIT" | cut -d '|' -f 3)
            echo "commit_${i}_msg=$MSG" >> $GITHUB_OUTPUT
            i=$((i+1))
          done

      - name: Build Adaptive Card JSON (push)
        if: ${{ inputs.cardType == 'push' }}
        shell: bash
        run: |
          cat > card.json << 'JSON'
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.5",
                  "body": [
                    { "type": "Container", "style": "good", "bleed": true,
                      "items": [
                        { "type": "TextBlock", "text": "â¬†ï¸ New Push to **${{ github.ref_name }}**", "weight": "Bolder", "size": "Large", "wrap": true }
                      ]
                    },
                    { "type": "FactSet",
                       "facts": [
                         { "title": "Pusher:", "value": "${{ github.actor }}" },
                         { "title": "Repository:", "value": "${{ github.repository }}" }
                       ]
                     },
                    {
                      "type": "TextBlock",
                      "text": "Latest commits",
                      "weight": "Bolder",
                      "spacing": "Medium"
                    },
                    { "type": "Container",
                      "items": [
                        { "type": "TextBlock", "text": "â€¢ ${{ steps.commits.outputs.commit_1_msg }}", "wrap": true, "isVisible": ${{ steps.commits.outputs.commit_1_msg != '' }} },
                        { "type": "TextBlock", "text": "â€¢ ${{ steps.commits.outputs.commit_2_msg }}", "wrap": true, "isVisible": ${{ steps.commits.outputs.commit_2_msg != '' }} },
                        { "type": "TextBlock", "text": "â€¢ ${{ steps.commits.outputs.commit_3_msg }}", "wrap": true, "isVisible": ${{ steps.commits.outputs.commit_3_msg != '' }} }
                      ]
                    },
                  ],
                  "actions": [
                    { "type": "Action.OpenUrl", "title": "ðŸ“‚ View Compare", "url": "${{ inputs.compare_url || format('https://github.com/{0}/compare', github.repository) }}" }
                  ]
                }
              }
            ]
          }
            JSON
            
      - name: Build Adaptive Card JSON (push)
        if: ${{ inputs.cardType != 'push' }}
        shell: bash
        run: |
          cat > card.json << 'JSON'
            {
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.5",
                    "body": [
                      { "type": "Container", "style": "attention", "bleed": true,
                        "items": [
                          { "type": "TextBlock", "text": "ðŸ”€ Pull Request Opened", "weight": "Bolder", "size": "Large", "wrap": true },
                          { "type": "TextBlock", "text": "**${{ inputs.pr_head }}** â†’ **${{ inputs.pr_base }}**", "weight": "Bolder", "wrap": true }
                        ]
                      },
                      { "type": "TextBlock", "text": "â€œ${{ inputs.pr_title }}â€ (#${{ inputs.pr_number }})", "size": "Medium", "weight": "Bolder", "wrap": true }
                    ],
                    "actions": [
                      { "type": "Action.OpenUrl", "title": "ðŸ”Ž View Pull Request", "url": "https://github.com/${{ github.repository }}/pull/${{ inputs.pr_number }}" }
                    ]
                  }
                }
              ]
            }
            JSON
            
      - name: Post to Teams
        run: |
          curl -sS -H "Content-Type: application/json" \
            -d @card.json \
            "${{ secrets.TEAMS_WEBHOOK_URL }}"
